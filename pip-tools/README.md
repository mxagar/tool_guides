# Pip-Tools Guide

Pip tools is a simpler alternative to [poetry](https://python-poetry.org/), which is a Python packaging and dependency manager. I have a small tutorial on Poetry in this same reporitory: [poetry](../poetry/).

The original repository of pip-tools [jazzband/pip-tools](https://github.com/jazzband/pip-tools) contains a nice tutorial on the package.

**Why `pip-tools`? Idea and workflow in a nutshell:**

- We want to have our applications and their dependencies predictable and deterministic; thus, we should **pin** the requirements, i.e., specfy their version.
- Pip-tools manages and tracks the package dependencies automatically even without us explicitly pinning them!
- Workflow:
  - We create a `requirements.in` with the necessary dependecies; alternatively, we can just define a `pyproject.toml`.
  - `pip-compile` creates a `requirements.txt` from the previous file; the automatically generated `requirements.txt` contains the correct versions and the versions of deeper dependencies.
  - We install those dependencies with `pip install -r requirements.txt`.
  - As an alternative to `pip install`, we can use `pip-sync requirements.txt`: that will update our environment according to what's in `requirements.txt`; note: do not forget to `pip-compile` beforehand to have an updated `requirements.txt`.
  - We should commit to the repository both `requirements.in` (`pyproject.toml`) and `requirements.txt`.

Table of contents:

- [Pip-Tools Guide](#pip-tools-guide)
  - [Basic Usage](#basic-usage)
  - [Further Tips](#further-tips)
  - [Interesting Links](#interesting-links)
  - [Authorship](#authorship)

## Basic Usage

First, we need to create a python environment and install `pip-tools` in it:

```bash
# setup project folder
mkdir example
cd example
touch requirements.in requirements-dev.in

# create & activate env
python -m venv venv
source venv/bin/activate
# this creates the local folder venv
# ... for Windows
py -m venv venv
.\venv\Scripts\activate

# install pip-tools
pip install -U pip-tools
```

Then, we fill in the requirements files, e.g.:

```
# requirements.in
numpy
pandas

# requirements-dev.in
-r requirements.txt
pytest
```

After those files have been defined, we can **compile** the pinned dependency files:

```bash
cd example

# generate/compile requirements.txt from requirements.in
pip-compile

# generate/compile requirements-dev.txt from requirements-dev.in
pip-compile requirements-dev.in
```

The generated/compiled files look like this:

```
## requirements.txt

#
# This file is autogenerated by pip-compile with Python 3.9
# by the following command:
#
#    pip-compile
#
numpy==1.26.1
    # via
    #   -r requirements.in
    #   pandas
pandas==2.1.2
    # via -r requirements.in
python-dateutil==2.8.2
    # via pandas
pytz==2023.3.post1
    # via pandas
six==1.16.0
    # via python-dateutil
tzdata==2023.3
    # via pandas

## requirements-dev.txt

#
# This file is autogenerated by pip-compile with Python 3.9
# by the following command:
#
#    pip-compile requirements-dev.in
#
colorama==0.4.6
    # via pytest
exceptiongroup==1.1.3
    # via pytest
iniconfig==2.0.0
    # via pytest
numpy==1.26.1
    # via
    #   -r requirements.txt
    #   pandas
packaging==23.2
    # via pytest
pandas==2.1.2
    # via -r requirements.txt
pluggy==1.3.0
    # via pytest
pytest==7.4.3
    # via -r requirements-dev.in
python-dateutil==2.8.2
    # via
    #   -r requirements.txt
    #   pandas
pytz==2023.3.post1
    # via
    #   -r requirements.txt
    #   pandas
six==1.16.0
    # via
    #   -r requirements.txt
    #   python-dateutil
tomli==2.0.1
    # via pytest
tzdata==2023.3
    # via
    #   -r requirements.txt
    #   pandas

```

Now, we can either `pip install -r requirements.txt` or use `pip-sync`, which automtically updates our `venv` by installing/upgrading/uninstalling everything necessary to match the `requirements.txt` contents. The same holds for the development environment with `requirements-dev.txt`.

```bash
# Install requirements, as always
pip install -r requirements.txt

# Alternative: use pip-sync
pip-sync # venv synced with requirements.txt
pip-sync requirements-dev.txt # venv synced with requirements-dev.txt
```

Note that we can also specify versions in the `requirements.in` files, as we'd do in regular `requirements.txt` files:

```
# requirements.in

numpy==1.26
pandas
```

Finally, don't forget committing all the requirement files to your repository!

```
requirements.in
requirements.txt
requirements-dev.in
requirements-dev.txt
```


## Further Tips

- We should define the requirement files for both
  - production: `requirements.in`
  - and development: `requirements-dev.in`
- We can create a `Makefile` which runs the `compile`, `install` and `sync` tasks

`Makefile`:

```makefile
# This is usually my first target so as soon as a developer clones
# a project and creates a virtualenv they can just run `make` to get things going.
install:
  @pip install \
  -r requirements.txt \
  -r requirements-dev.txt

compile:
  @rm -f requirements*.txt
  @pip-compile requirements.in
  @pip-compile requirements-dev.in
    
sync:
  @pip-sync requirements*.txt

# Test that everything is working...
test:
  #...
```

Usage:

```bash
# Create venv
python -m venv env-name
source env-name/bin/activate

# Compile requirements & install
make compile && make sync

# Test (optional)
make test

# ... some time later ...

# Sync/Update in case versions have changed
make compile && make sync
```


## Interesting Links

- [Quick tip: How I use pip-tools to wrangle dependencies](https://www.codementor.io/@adammertz/quick-tip-how-i-use-pip-tools-to-wrangle-dependencies-1fzreskhok)
- [Managing your requirements.txt with pip-tools in python](https://suyojtamrakar.medium.com/managing-your-requirements-txt-with-pip-tools-in-python-8d07d9dfa464)


## Authorship

Mikel Sagardia, 2023.  
No guarantees.
